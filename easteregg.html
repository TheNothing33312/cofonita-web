<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofonita: Agente de Datos - Easter Egg</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a14;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            user-select: none;
        }

        /* Pantalla de carga futurista */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a14 0%, #121220 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease;
        }

        .loading-logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 64px;
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #FF6B8B 0%, #5A67D8 50%, #00D4AA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }

        .loading-logo::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 4px;
            background: linear-gradient(90deg, transparent, #FF6B8B, #5A67D8, #00D4AA, transparent);
            border-radius: 2px;
        }

        #loadingProgressContainer {
            width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #loadingProgress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FF6B8B, #5A67D8, #00D4AA);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .loading-tip {
            color: #A0A0C0;
            font-size: 14px;
            margin-top: 20px;
            text-align: center;
            max-width: 400px;
            line-height: 1.4;
            opacity: 0.7;
        }

        /* Menú principal */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #121220 0%, #0a0a14 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9000;
        }

        .menu-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 72px;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #FF6B8B 0%, #5A67D8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .menu-subtitle {
            color: #A0A0C0;
            font-size: 18px;
            margin-bottom: 50px;
            text-align: center;
        }

        .menu-btn {
            width: 320px;
            padding: 18px;
            margin: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            text-align: center;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: 0.5s;
        }

        .menu-btn:hover::before {
            left: 100%;
        }

        .menu-btn:hover {
            background: rgba(90, 103, 216, 0.2);
            border-color: #5A67D8;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(90, 103, 216, 0.3);
        }

        .menu-btn-primary {
            background: linear-gradient(135deg, #FF6B8B 0%, #5A67D8 100%);
            border: none;
        }

        .menu-btn-primary:hover {
            background: linear-gradient(135deg, #FF4D6D 0%, #4C51BF 100%);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(255, 107, 139, 0.4);
        }

        /* Canvas del juego */
        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none;
            cursor: crosshair;
        }

        /* Modo combate */
        #combatCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: none;
        }

        /* Interfaz de usuario mejorada */
        #uiOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        /* Barra de datos del agente */
        .data-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(18, 18, 32, 0.9);
            border-radius: 16px;
            padding: 15px;
            border: 2px solid rgba(255, 107, 139, 0.3);
            backdrop-filter: blur(10px);
            min-width: 250px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .data-label {
            color: #A0A0C0;
            font-size: 14px;
            font-weight: 500;
        }

        .data-value {
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
        }

        .health-bar, .energy-bar, .data-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .health-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #FF5252, #FF6B8B);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .energy-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00D4AA, #00E5A0);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .data-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #5A67D8, #818CF8);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Minimapa holográfico */
        .hologram-map {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 180px;
            height: 180px;
            background: rgba(18, 18, 32, 0.7);
            border-radius: 50%;
            border: 2px solid #00D4AA;
            box-shadow: 0 0 30px rgba(0, 212, 170, 0.3);
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        .hologram-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 170, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 170, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Panel de misión */
        .mission-panel {
            position: absolute;
            bottom: 120px;
            left: 20px;
            background: rgba(18, 18, 32, 0.9);
            border-radius: 16px;
            padding: 20px;
            border-left: 6px solid #FF6B8B;
            max-width: 400px;
            backdrop-filter: blur(10px);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .mission-panel:hover {
            transform: translateY(-5px);
        }

        .mission-title {
            color: #FF6B8B;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .mission-desc {
            color: #fff;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .mission-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .mission-progress-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FF6B8B, #FF8FA3);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Diálogos flotantes */
        .dialogue-bubble {
            position: absolute;
            background: rgba(18, 18, 32, 0.95);
            border-radius: 16px;
            padding: 20px;
            max-width: 300px;
            border: 2px solid #5A67D8;
            backdrop-filter: blur(10px);
            z-index: 150;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .dialogue-bubble.active {
            opacity: 1;
            transform: translateY(0);
        }

        .dialogue-speaker {
            color: #FF6B8B;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .dialogue-text {
            color: #fff;
            font-size: 14px;
            line-height: 1.5;
        }

        .dialogue-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B8B, #5A67D8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        /* Notificaciones sutiles */
        .notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateY(-100px);
            background: rgba(18, 18, 32, 0.9);
            padding: 15px 25px;
            border-radius: 12px;
            border: 2px solid #00D4AA;
            backdrop-filter: blur(10px);
            display: none;
            animation: notificationSlide 0.5s ease-out;
            text-align: center;
            z-index: 200;
        }

        @keyframes notificationSlide {
            from {
                transform: translate(-50%, -50%) translateY(-150px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) translateY(-100px);
                opacity: 1;
            }
        }

        .notification-title {
            color: #00D4AA;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .notification-text {
            color: #fff;
            font-size: 14px;
        }

        /* Menú de pausa */
        #pauseMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(20px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9000;
        }

        /* Panel de hackeo */
        .hack-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(18, 18, 32, 0.95);
            border-radius: 20px;
            padding: 30px;
            border: 3px solid #5A67D8;
            display: none;
            z-index: 1000;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .hack-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .hack-node {
            width: 60px;
            height: 60px;
            background: rgba(90, 103, 216, 0.2);
            border: 2px solid #5A67D8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 20px;
            color: white;
        }

        .hack-node:hover {
            background: rgba(90, 103, 216, 0.4);
            transform: scale(1.1);
        }

        .hack-node.activated {
            background: #00D4AA;
            border-color: #00E5A0;
        }

        /* Efectos visuales */
        .scan-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00D4AA, transparent);
            z-index: 50;
            display: none;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% {
                top: 0;
                opacity: 0.5;
            }
            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .data-stream {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
            opacity: 0.1;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 212, 170, 0.1) 1px,
                    rgba(0, 212, 170, 0.1) 2px
                );
        }

        /* Controles */
        .controls-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(18, 18, 32, 0.7);
            padding: 12px;
            border-radius: 12px;
            font-size: 12px;
            line-height: 1.4;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 2px;
            font-family: 'Space Grotesk', monospace;
        }

        /* Versión */
        .version {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: rgba(160, 160, 192, 0.5);
            font-size: 12px;
            font-family: 'Space Grotesk', monospace;
        }
    </style>
</head>
<body>
    <!-- Pantalla de carga -->
    <div id="loadingScreen">
        <div class="loading-logo">COFONITA: AGENTE DE DATOS</div>
        <div id="loadingProgressContainer">
            <div id="loadingProgress"></div>
        </div>
        <div id="loadingStatus" class="loading-tip">Inicializando sistemas de hackeo...</div>
        <div class="loading-tip">¿Sabías que? Cofonita protege más de 100 servidores de Discord</div>
    </div>

    <!-- Menú principal -->
    <div id="mainMenu">
        <h1 class="menu-title">COFONITA: AGENTE DE DATOS</h1>
        <p class="menu-subtitle">Un easter egg del panel de Cofonita V4</p>
        <button class="menu-btn menu-btn-primary" onclick="startNewGame()">NUEVA MISIÓN</button>
        <button class="menu-btn" onclick="continueGame()">CONTINUAR OPERACIÓN</button>
        <button class="menu-btn" onclick="showCredits()">CRÉDITOS Y LORE</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">VOLVER AL PANEL</button>
        <div class="version">v1.0.3 | Easter Egg de Cofonita Studios</div>
    </div>

    <!-- Canvas del juego principal -->
    <canvas id="gameCanvas"></canvas>

    <!-- Canvas del modo combate -->
    <canvas id="combatCanvas"></canvas>

    <!-- Interfaz de usuario -->
    <div id="uiOverlay">
        <!-- Panel de datos del agente -->
        <div class="data-panel">
            <div class="data-row">
                <span class="data-label">AGENTE:</span>
                <span class="data-value" id="agentName">C4PT41N_0N3</span>
            </div>
            <div class="health-bar">
                <div class="health-fill" id="healthFill"></div>
            </div>
            <div class="data-row">
                <span class="data-label">INTEGRIDAD:</span>
                <span class="data-value" id="healthText">100%</span>
            </div>
            <div class="energy-bar">
                <div class="energy-fill" id="energyFill"></div>
            </div>
            <div class="data-row">
                <span class="data-label">ENERGÍA:</span>
                <span class="data-value" id="energyText">100%</span>
            </div>
            <div class="data-bar">
                <div class="data-fill" id="dataFill"></div>
            </div>
            <div class="data-row">
                <span class="data-label">DATOS:</span>
                <span class="data-value" id="dataText">0/10 GB</span>
            </div>
        </div>

        <!-- Minimapa holográfico -->
        <div class="hologram-map">
            <div class="hologram-grid"></div>
            <canvas id="miniMapCanvas" width="180" height="180"></canvas>
        </div>

        <!-- Panel de misión -->
        <div class="mission-panel" id="missionPanel">
            <div class="mission-title">OPERACIÓN: <span id="missionTitle">INFILTRACIÓN INICIAL</span></div>
            <div class="mission-desc" id="missionDesc">
                Conéctate al nodo principal y descarga los datos de configuración.
            </div>
            <div class="mission-progress">
                <div class="mission-progress-fill" id="missionProgress"></div>
            </div>
        </div>

        <!-- Diálogos flotantes -->
        <div class="dialogue-bubble" id="dialogueBubble">
            <div class="dialogue-avatar" id="dialogueAvatar">S</div>
            <div class="dialogue-speaker" id="dialogueSpeaker">Salvox</div>
            <div class="dialogue-text" id="dialogueText">Texto del diálogo aquí...</div>
        </div>

        <!-- Notificaciones -->
        <div class="notification" id="notification">
            <div class="notification-title" id="notificationTitle">DATOS DESCARGADOS</div>
            <div class="notification-text" id="notificationText">+500 MB obtenidos</div>
        </div>

        <!-- Controles -->
        <div class="controls-hint">
            <span class="control-key">WASD</span> Moverse |
            <span class="control-key">E</span> Interactuar |
            <span class="control-key">ESPACIO</span> Hackear |
            <span class="control-key">TAB</span> Pausa
        </div>
    </div>

    <!-- Panel de hackeo -->
    <div class="hack-panel" id="hackPanel">
        <h2 style="color: #5A67D8; margin-bottom: 20px; text-align: center;">SISTEMA DE HACKEO</h2>
        <div style="color: #A0A0C0; text-align: center; margin-bottom: 20px;" id="hackTarget">
            Objetivo: Nodo de Datos Principal
        </div>
        <div class="hack-grid" id="hackGrid">
            <!-- Los nodos se generan dinámicamente -->
        </div>
        <div style="color: #fff; text-align: center; margin: 20px 0;" id="hackTimer">
            Tiempo: <span id="hackTime">10</span>s
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="menu-btn" onclick="cancelHack()" style="width: auto; pointer-events: all;">CANCELAR</button>
            <button class="menu-btn menu-btn-primary" onclick="executeHack()" style="width: auto; pointer-events: all;" id="hackBtn">INICIAR HACKEO</button>
        </div>
    </div>

    <!-- Menú de pausa -->
    <div id="pauseMenu">
        <h1 class="menu-title">OPERACIÓN EN PAUSA</h1>
        <p class="menu-subtitle">Sistema de misión de Cofonita</p>
        <button class="menu-btn" onclick="resumeGame()">REANUDAR OPERACIÓN</button>
        <button class="menu-btn" onclick="saveGame()">GUARDAR PROGRESO</button>
        <button class="menu-btn" onclick="showSettings()">CONFIGURACIÓN</button>
        <button class="menu-btn" onclick="returnToMenu()">MENÚ PRINCIPAL</button>
    </div>

    <!-- Efectos visuales -->
    <div class="scan-line" id="scanLine"></div>
    <div class="data-stream"></div>

    <script>
        // ==============================================
        // HISTORIA ORIGINAL: COFONITA - AGENTE DE DATOS
        // ==============================================

        /*
            LORE:
            En el año 2026, Cofonita se ha convertido en la inteligencia artificial
            encargada de proteger las comunidades de Discord. Pero una organización
            rival llamada "Los Fragmentadores" está intentando corromper los datos.
            
            Tú eres un agente digital creado por Salvox, enviado al ciberespacio
            para proteger los servidores y recuperar datos robados.
        */

        // ================= CONFIGURACIÓN =================
        const CONFIG = {
            VERSION: '1.0.3',
            SAVE_KEY: 'cofonita_agent_save',
            AUTO_SAVE_INTERVAL: 45000,
            DEBUG_MODE: false
        };

        // ================= PERSONAJES =================
        const CHARACTERS = {
            SALVOX: {
                name: "Salvox",
                color: "#5A67D8",
                avatar: "S",
                role: "Creador de Cofonita",
                dialogues: [
                    "Agente, los Fragmentadores están atacando nuestro nodo principal.",
                    "Necesito que recuperes los datos de configuración antes que los corrompan.",
                    "Usa tus habilidades de hackeo en los terminales azules.",
                    "¡Cuidado con los guardias digitales! Son programas de defensa.",
                    "Excelente trabajo. Los datos están a salvo... por ahora."
                ]
            },
            FRAGMENTADOR: {
                name: "Fragmentador",
                color: "#FF5252",
                avatar: "F",
                role: "Agente enemigo",
                dialogues: [
                    "¡Intruso detectado! Activando protocolos de defensa.",
                    "Nuestro líder, Corruptor Primario, te destruirá.",
                    "Los datos de Cofonita serán nuestros.",
                    "¡Sistema de defensa activado!"
                ]
            },
            VENDEDOR: {
                name: "Bit Merchant",
                color: "#FFB74D",
                avatar: "B",
                role: "Comerciante de datos",
                dialogues: [
                    "¿Necesitas upgrades, agente? Tengo justo lo que necesitas.",
                    "Este firewall mejorado te protegerá de los ataques.",
                    "Los datos de inteligencia cuestan, pero valen la pena."
                ]
            }
        };

        // ================= MISIONES =================
        const MISSIONS = [
            {
                id: 1,
                title: "INFILTRACIÓN INICIAL",
                description: "Conéctate al nodo principal y descarga los datos de configuración.",
                objectives: [
                    "Encuentra el terminal principal (azul)",
                    "Hackea el sistema de seguridad",
                    "Descarga los datos de configuración"
                ],
                reward: { data: 1000, exp: 500 },
                nextMission: 2
            },
            {
                id: 2,
                title: "DEFENSA DEL NÚCLEO",
                description: "Protege el núcleo de Cofonita de los ataques de los Fragmentadores.",
                objectives: [
                    "Elimina 3 guardias digitales",
                    "Activa el firewall principal",
                    "Protege el núcleo por 60 segundos"
                ],
                reward: { data: 2000, exp: 1000 },
                nextMission: 3
            },
            {
                id: 3,
                title: "CONTRAATAQUE",
                description: "Infíltrate en la base de los Fragmentadores y destruye su servidor.",
                objectives: [
                    "Encuentra la base enemiga",
                    "Hackea los sistemas de defensa",
                    "Destruye el servidor principal"
                ],
                reward: { data: 5000, exp: 2000 },
                nextMission: 4
            }
        ];

        // ================= ESTADO DEL JUEGO =================
        let gameState = {
            agent: {
                name: "C4PT41N_0N3",
                level: 1,
                exp: 0,
                health: 100,
                maxHealth: 100,
                energy: 100,
                maxEnergy: 100,
                dataCollected: 0,
                dataCapacity: 10000,
                position: { x: 400, y: 300 },
                rotation: 0,
                upgrades: {
                    hackSpeed: 1,
                    firewall: 1,
                    stealth: 1
                },
                inventory: [
                    { id: "basic_hack", name: "Kit de Hackeo Básico", type: "tool" },
                    { id: "firewall", name: "Firewall Nivel 1", type: "defense" }
                ]
            },
            mission: {
                current: 1,
                completed: [],
                objectives: [],
                progress: 0
            },
            world: {
                time: 0,
                discoveredAreas: ["zona_principal"],
                enemiesDefeated: 0,
                terminalsHacked: 0
            },
            story: {
                chapter: 1,
                dialoguesHeard: [],
                loreDiscovered: 0
            },
            settings: {
                sound: true,
                music: true,
                autosave: true,
                effects: true
            }
        };

        // ================= ELEMENTOS DOM =================
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingProgress = document.getElementById('loadingProgress');
        const loadingStatus = document.getElementById('loadingStatus');
        const mainMenu = document.getElementById('mainMenu');
        const gameCanvas = document.getElementById('gameCanvas');
        const combatCanvas = document.getElementById('combatCanvas');
        const ctx = gameCanvas.getContext('2d');
        const combatCtx = combatCanvas.getContext('2d');
        const uiOverlay = document.getElementById('uiOverlay');
        const pauseMenu = document.getElementById('pauseMenu');
        const hackPanel = document.getElementById('hackPanel');
        const hackGrid = document.getElementById('hackGrid');
        const hackTimer = document.getElementById('hackTime');
        const hackTarget = document.getElementById('hackTarget');
        const dialogueBubble = document.getElementById('dialogueBubble');
        const notification = document.getElementById('notification');
        const scanLine = document.getElementById('scanLine');

        // ================= VARIABLES DEL JUEGO =================
        let gameLoaded = false;
        let isPaused = false;
        let isHacking = false;
        let isInCombat = false;
        let keys = {};
        let mouse = { x: 0, y: 0, down: false };
        let lastTime = 0;
        let deltaTime = 0;
        let gameLoopId = null;
        let autoSaveTimer = null;
        let dialogueTimer = null;
        let hackSequence = [];
        let hackTimeLeft = 10;
        let hackInterval = null;

        // ================= MUNDO DEL JUEGO =================
        const WORLD = {
            width: 1600,
            height: 1200,
            gridSize: 64,
            areas: [
                {
                    id: "zona_principal",
                    name: "Núcleo de Cofonita",
                    color: "#5A67D8",
                    position: { x: 400, y: 300 },
                    radius: 200,
                    npcs: ["salvox"]
                },
                {
                    id: "terminal_area",
                    name: "Área de Terminales",
                    color: "#00D4AA",
                    position: { x: 800, y: 400 },
                    radius: 150,
                    terminals: 3
                },
                {
                    id: "enemy_base",
                    name: "Base Fragmentadora",
                    color: "#FF5252",
                    position: { x: 1200, y: 600 },
                    radius: 180,
                    enemies: 5
                }
            ],
            terminals: [
                { id: 1, position: { x: 850, y: 350 }, type: "data", hacked: false },
                { id: 2, position: { x: 750, y: 450 }, type: "security", hacked: false },
                { id: 3, position: { x: 900, y: 500 }, type: "mainframe", hacked: false }
            ],
            enemies: [
                { id: 1, position: { x: 1100, y: 550 }, type: "guard", health: 100 },
                { id: 2, position: { x: 1150, y: 600 }, type: "guard", health: 100 },
                { id: 3, position: { x: 1200, y: 650 }, type: "sentry", health: 150 }
            ]
        };

        // ================= SISTEMA DE CARGA =================
        const LOADING_TIPS = [
            "Cargando protocolos de hackeo...",
            "Inicializando interfaz neural...",
            "Conectando al núcleo de Cofonita...",
            "Verificando sistemas de seguridad...",
            "Preparando simulador de datos...",
            "Cargando historial de misiones...",
            "Iniciando secuencia de easter egg..."
        ];

        function updateLoading(progress, message) {
            loadingProgress.style.width = `${progress}%`;
            loadingStatus.textContent = message;
            
            if (CONFIG.DEBUG_MODE) {
                console.log(`[Carga] ${progress}% - ${message}`);
            }
        }

        async function loadGame() {
            let progress = 0;
            
            // Fase 1: Motor del juego
            updateLoading(10, LOADING_TIPS[0]);
            await new Promise(r => setTimeout(r, 300));
            
            // Fase 2: Gráficos
            progress = 30;
            updateLoading(progress, LOADING_TIPS[1]);
            await new Promise(r => setTimeout(r, 400));
            
            // Fase 3: Sistema de guardado
            progress = 50;
            updateLoading(progress, LOADING_TIPS[2]);
            await new Promise(r => setTimeout(r, 300));
            
            // Fase 4: IA y NPCs
            progress = 70;
            updateLoading(progress, LOADING_TIPS[3]);
            await new Promise(r => setTimeout(r, 400));
            
            // Fase 5: Interfaz y efectos
            progress = 90;
            updateLoading(progress, LOADING_TIPS[4]);
            await new Promise(r => setTimeout(r, 300));
            
            // Fase 6: Finalización
            progress = 100;
            updateLoading(progress, LOADING_TIPS[5]);
            await new Promise(r => setTimeout(r, 500));
            
            // Completado
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainMenu.style.display = 'flex';
                loadSavedGame();
            }, 800);
        }

        // ================= SISTEMA DE GUARDADO =================
        function saveGame() {
            try {
                // Actualizar estadísticas
                gameState.world.time += deltaTime / 1000;
                
                const saveData = {
                    version: CONFIG.VERSION,
                    timestamp: Date.now(),
                    gameState: gameState
                };
                
                localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(saveData));
                showNotification("PROGRESO GUARDADO", "Datos sincronizados en el núcleo");
                
                if (CONFIG.DEBUG_MODE) {
                    console.log("[Guardado] Juego guardado correctamente");
                }
                
                return true;
            } catch (error) {
                console.error("[Error] Fallo al guardar:", error);
                return false;
            }
        }

        function loadSavedGame() {
            try {
                const saved = localStorage.getItem(CONFIG.SAVE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    if (data.version === CONFIG.VERSION) {
                        gameState = data.gameState;
                        
                        if (CONFIG.DEBUG_MODE) {
                            console.log("[Carga] Partida recuperada del almacenamiento");
                        }
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error("[Error] Fallo al cargar:", error);
            }
            return false;
        }

        // ================= SISTEMA DE DIÁLOGOS =================
        function showDialogue(character, text, duration = 4000) {
            if (!gameState.settings.sound) return;
            
            const avatar = dialogueBubble.querySelector('#dialogueAvatar');
            const speaker = dialogueBubble.querySelector('#dialogueSpeaker');
            const dialogueText = dialogueBubble.querySelector('#dialogueText');
            
            avatar.textContent = character.avatar;
            avatar.style.background = `linear-gradient(135deg, ${character.color}, ${character.color}88)`;
            speaker.textContent = character.name;
            speaker.style.color = character.color;
            dialogueText.textContent = text;
            
            // Posicionar cerca del jugador
            const playerPos = gameState.agent.position;
            const screenX = window.innerWidth / 2;
            const screenY = window.innerHeight / 2 - 100;
            
            dialogueBubble.style.left = `${screenX}px`;
            dialogueBubble.style.top = `${screenY}px`;
            
            // Mostrar diálogo
            dialogueBubble.classList.add('active');
            
            // Ocultar después de la duración
            if (dialogueTimer) clearTimeout(dialogueTimer);
            dialogueTimer = setTimeout(() => {
                dialogueBubble.classList.remove('active');
            }, duration);
            
            // Registrar en la historia
            if (!gameState.story.dialoguesHeard.includes(text)) {
                gameState.story.dialoguesHeard.push(text);
                gameState.story.loreDiscovered++;
            }
        }

        function showNotification(title, text) {
            const notifTitle = document.getElementById('notificationTitle');
            const notifText = document.getElementById('notificationText');
            
            notifTitle.textContent = title;
            notifText.textContent = text;
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // ================= SISTEMA DE HACKEO =================
        function generateHackSequence() {
            hackSequence = [];
            hackGrid.innerHTML = '';
            
            const sequenceLength = 4 + Math.floor(gameState.agent.upgrades.hackSpeed / 2);
            
            for (let i = 0; i < 16; i++) {
                const node = document.createElement('div');
                node.className = 'hack-node';
                node.textContent = i.toString(16).toUpperCase();
                node.dataset.index = i;
                
                node.addEventListener('click', () => {
                    if (isHacking && !node.classList.contains('activated')) {
                        node.classList.add('activated');
                        hackSequence.push(i);
                        
                        if (hackSequence.length === sequenceLength) {
                            checkHackSequence();
                        }
                    }
                });
                
                hackGrid.appendChild(node);
            }
        }

        function startHacking(target) {
            isHacking = true;
            isPaused = true;
            hackPanel.style.display = 'block';
            hackTarget.textContent = `Objetivo: ${target}`;
            hackTimeLeft = 10 / gameState.agent.upgrades.hackSpeed;
            
            generateHackSequence();
            
            hackInterval = setInterval(() => {
                hackTimeLeft--;
                hackTimer.textContent = hackTimeLeft;
                
                if (hackTimeLeft <= 0) {
                    hackFailed();
                }
            }, 1000);
        }

        function checkHackSequence() {
            clearInterval(hackInterval);
            
            // Verificar secuencia (simplificado)
            const success = hackSequence.length >= 4;
            
            if (success) {
                showNotification("HACKEO EXITOSO", "+500 MB de datos obtenidos");
                gameState.agent.dataCollected += 500;
                gameState.world.terminalsHacked++;
                
                // Actualizar misión
                if (gameState.mission.current === 1) {
                    gameState.mission.progress = Math.min(100, gameState.mission.progress + 33);
                    updateMissionProgress();
                }
            } else {
                showNotification("HACKEO FALLIDO", "Sistema de seguridad activado");
                gameState.agent.health -= 10;
            }
            
            endHacking();
        }

        function hackFailed() {
            clearInterval(hackInterval);
            showNotification("TIEMPO AGOTADO", "Alerta de seguridad activada");
            gameState.agent.health -= 15;
            endHacking();
        }

        function cancelHack() {
            clearInterval(hackInterval);
            endHacking();
        }

        function executeHack() {
            const hackBtn = document.getElementById('hackBtn');
            hackBtn.textContent = "HACKEANDO...";
            hackBtn.disabled = true;
            
            setTimeout(() => {
                checkHackSequence();
            }, 1000);
        }

        function endHacking() {
            isHacking = false;
            isPaused = false;
            hackPanel.style.display = 'none';
            hackSequence = [];
        }

        // ================= INICIO DEL JUEGO =================
        async function startNewGame() {
            mainMenu.style.display = 'none';
            
            // Resetear estado
            gameState = {
                agent: {
                    name: "C4PT41N_0N3",
                    level: 1,
                    exp: 0,
                    health: 100,
                    maxHealth: 100,
                    energy: 100,
                    maxEnergy: 100,
                    dataCollected: 0,
                    dataCapacity: 10000,
                    position: { x: 400, y: 300 },
                    rotation: 0,
                    upgrades: {
                        hackSpeed: 1,
                        firewall: 1,
                        stealth: 1
                    },
                    inventory: [
                        { id: "basic_hack", name: "Kit de Hackeo Básico", type: "tool" },
                        { id: "firewall", name: "Firewall Nivel 1", type: "defense" }
                    ]
                },
                mission: {
                    current: 1,
                    completed: [],
                    objectives: [...MISSIONS[0].objectives],
                    progress: 0
                },
                world: {
                    time: 0,
                    discoveredAreas: ["zona_principal"],
                    enemiesDefeated: 0,
                    terminalsHacked: 0
                },
                story: {
                    chapter: 1,
                    dialoguesHeard: [],
                    loreDiscovered: 0
                },
                settings: {
                    sound: true,
                    music: true,
                    autosave: true,
                    effects: true
                }
            };
            
            // Cinemática inicial
            await showCutscene([
                "AÑO 2026 - NÚCLEO DE COFONITA",
                "Los Fragmentadores han comenzado su ataque...",
                "Como Agente de Datos, tu misión es proteger",
                "la infraestructura digital de Cofonita.",
                "Salvox te guiará en esta operación."
            ]);
            
            initGame();
        }

        async function showCutscene(messages) {
            for (const message of messages) {
                showNotification("TRANSMISIÓN", message);
                await new Promise(r => setTimeout(r, 2000));
            }
        }

        function continueGame() {
            if (loadSavedGame()) {
                mainMenu.style.display = 'none';
                initGame();
            } else {
                showNotification("ERROR", "No hay datos de misión previos");
            }
        }

        function initGame() {
            // Configurar canvas
            resizeCanvases();
            
            // Configurar controles
            setupControls();
            
            // Mostrar interfaz
            uiOverlay.style.display = 'block';
            gameCanvas.style.display = 'block';
            
            // Actualizar UI
            updateUI();
            updateMissionDisplay();
            
            // Diálogo inicial
            setTimeout(() => {
                showDialogue(CHARACTERS.SALVOX, CHARACTERS.SALVOX.dialogues[0]);
            }, 1000);
            
            // Iniciar bucle del juego
            lastTime = performance.now();
            gameLoopId = requestAnimationFrame(gameLoop);
            
            gameLoaded = true;
            
            // Auto-guardado
            if (gameState.settings.autosave) {
                autoSaveTimer = setInterval(saveGame, CONFIG.AUTO_SAVE_INTERVAL);
            }
            
            // Efecto de escaneo
            if (gameState.settings.effects) {
                setInterval(() => {
                    scanLine.style.display = 'block';
                    setTimeout(() => {
                        scanLine.style.display = 'none';
                    }, 2000);
                }, 5000);
            }
        }

        // ================= CONTROLES =================
        function setupControls() {
            // Teclado
            window.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                keys[key] = true;
                
                if (key === 'tab' || key === 'escape') {
                    e.preventDefault();
                    togglePause();
                }
                
                if (key === 'e' && !isPaused && !isHacking) {
                    checkInteraction();
                }
                
                if (key === ' ' && !isPaused && !isHacking) {
                    // Hackeo rápido si está cerca de terminal
                    checkTerminalHack();
                }
                
                // Debug
                if (CONFIG.DEBUG_MODE && key === 'f1') {
                    gameState.agent.dataCollected += 1000;
                    updateUI();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });
            
            // Ratón
            gameCanvas.addEventListener('mousemove', (e) => {
                const rect = gameCanvas.getBoundingClientRect();
                mouse.x = e.clientX - rect.left;
                mouse.y = e.clientY - rect.top;
            });
            
            gameCanvas.addEventListener('mousedown', () => {
                mouse.down = true;
            });
            
            gameCanvas.addEventListener('mouseup', () => {
                mouse.down = false;
            });
            
            // Redimensionamiento
            window.addEventListener('resize', resizeCanvases);
        }

        function resizeCanvases() {
            gameCanvas.width = window.innerWidth;
            gameCanvas.height = window.innerHeight;
            combatCanvas.width = window.innerWidth;
            combatCanvas.height = window.innerHeight;
        }

        // ================= BUCLE DEL JUEGO =================
        function gameLoop(currentTime) {
            if (!gameLoaded || isPaused || isHacking) {
                lastTime = currentTime;
                if (gameLoaded) {
                    gameLoopId = requestAnimationFrame(gameLoop);
                }
                return;
            }
            
            deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // Actualizar lógica
            updateGame(deltaTime);
            
            // Renderizar
            renderGame();
            
            // Continuar bucle
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        // ================= ACTUALIZACIÓN =================
        function updateGame(dt) {
            // Regenerar energía
            gameState.agent.energy = Math.min(
                gameState.agent.maxEnergy,
                gameState.agent.energy + 0.01 * dt
            );
            
            // Movimiento
            const speed = 0.2 * dt * gameState.agent.upgrades.stealth;
            
            if (keys['w'] || keys['arrowup']) {
                gameState.agent.position.y -= speed;
                gameState.agent.rotation = -Math.PI / 2;
            }
            if (keys['s'] || keys['arrowdown']) {
                gameState.agent.position.y += speed;
                gameState.agent.rotation = Math.PI / 2;
            }
            if (keys['a'] || keys['arrowleft']) {
                gameState.agent.position.x -= speed;
                gameState.agent.rotation = Math.PI;
            }
            if (keys['d'] || keys['arrowright']) {
                gameState.agent.position.x += speed;
                gameState.agent.rotation = 0;
            }
            
            // Limitar al mundo
            gameState.agent.position.x = Math.max(50, Math.min(WORLD.width - 50, gameState.agent.position.x));
            gameState.agent.position.y = Math.max(50, Math.min(WORLD.height - 50, gameState.agent.position.y));
            
            // Actualizar tiempo
            gameState.world.time += dt / 1000;
            
            // Actualizar UI
            updateUI();
        }

        function checkInteraction() {
            const pos = gameState.agent.position;
            
            // Verificar terminales
            for (const terminal of WORLD.terminals) {
                const dist = Math.sqrt(
                    Math.pow(pos.x - terminal.position.x, 2) +
                    Math.pow(pos.y - terminal.position.y, 2)
                );
                
                if (dist < 80 && !terminal.hacked) {
                    startHacking(`Terminal ${terminal.type.toUpperCase()}`);
                    return;
                }
            }
            
            // Verificar NPCs
            const salvoxPos = WORLD.areas[0].position;
            const distToSalvox = Math.sqrt(
                Math.pow(pos.x - salvoxPos.x, 2) +
                Math.pow(pos.y - salvoxPos.y, 2)
            );
            
            if (distToSalvox < 100) {
                const dialogueIndex = Math.min(gameState.mission.current - 1, CHARACTERS.SALVOX.dialogues.length - 1);
                showDialogue(CHARACTERS.SALVOX, CHARACTERS.SALVOX.dialogues[dialogueIndex]);
                return;
            }
        }

        function checkTerminalHack() {
            const pos = gameState.agent.position;
            
            for (const terminal of WORLD.terminals) {
                const dist = Math.sqrt(
                    Math.pow(pos.x - terminal.position.x, 2) +
                    Math.pow(pos.y - terminal.position.y, 2)
                );
                
                if (dist < 100 && !terminal.hacked) {
                    startHacking(`Terminal ${terminal.type.toUpperCase()}`);
                    break;
                }
            }
        }

        // ================= RENDERIZADO =================
        function renderGame() {
            // Limpiar canvas
            ctx.fillStyle = '#0a0a14';
            ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // Calcular offset de cámara
            const offsetX = gameCanvas.width / 2 - gameState.agent.position.x;
            const offsetY = gameCanvas.height / 2 - gameState.agent.position.y;
            
            // Dibujar mundo
            drawWorld(ctx, offsetX, offsetY);
            
            // Dibujar entidades
            drawEntities(ctx, offsetX, offsetY);
            
            // Dibujar jugador
            drawPlayer(ctx);
            
            // Dibujar efectos
            if (gameState.settings.effects) {
                drawEffects(ctx);
            }
        }

        function drawWorld(ctx, offsetX, offsetY) {
            // Fondo de red
            ctx.strokeStyle = 'rgba(90, 103, 216, 0.1)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x < WORLD.width; x += 100) {
                ctx.beginPath();
                ctx.moveTo(x + offsetX, 0);
                ctx.lineTo(x + offsetX, gameCanvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < WORLD.height; y += 100) {
                ctx.beginPath();
                ctx.moveTo(0, y + offsetY);
                ctx.lineTo(gameCanvas.width, y + offsetY);
                ctx.stroke();
            }
            
            // Áreas
            WORLD.areas.forEach(area => {
                ctx.fillStyle = area.color + '20';
                ctx.beginPath();
                ctx.arc(
                    area.position.x + offsetX,
                    area.position.y + offsetY,
                    area.radius,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                
                // Borde
                ctx.strokeStyle = area.color;
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Nombre
                ctx.fillStyle = area.color;
                ctx.font = '14px "Space Grotesk"';
                ctx.textAlign = 'center';
                ctx.fillText(
                    area.name,
                    area.position.x + offsetX,
                    area.position.y + offsetY - area.radius - 10
                );
            });
            
            // Terminales
            WORLD.terminals.forEach(terminal => {
                ctx.fillStyle = terminal.hacked ? '#00D4AA' : '#5A67D8';
                ctx.beginPath();
                ctx.arc(
                    terminal.position.x + offsetX,
                    terminal.position.y + offsetY,
                    25,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                
                // Icono
                ctx.fillStyle = '#fff';
                ctx.font = '16px "Space Grotesk"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(
                    '⌬',
                    terminal.position.x + offsetX,
                    terminal.position.y + offsetY
                );
            });
        }

        function drawEntities(ctx, offsetX, offsetY) {
            // Enemigos
            WORLD.enemies.forEach(enemy => {
                ctx.fillStyle = '#FF5252';
                ctx.beginPath();
                ctx.arc(
                    enemy.position.x + offsetX,
                    enemy.position.y + offsetY,
                    20,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                
                // Indicador de salud
                ctx.fillStyle = '#FF6B8B';
                ctx.fillRect(
                    enemy.position.x + offsetX - 25,
                    enemy.position.y + offsetY - 30,
                    50 * (enemy.health / 100),
                    5
                );
            });
        }

        function drawPlayer(ctx) {
            const centerX = gameCanvas.width / 2;
            const centerY = gameCanvas.height / 2;
            
            // Cuerpo del agente
            ctx.fillStyle = '#FF6B8B';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, Math.PI * 2);
            ctx.fill();
            
            // Detalles
            ctx.fillStyle = '#fff';
            ctx.font = '20px "Space Grotesk"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('C', centerX, centerY);
            
            // Dirección
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(
                centerX + Math.cos(gameState.agent.rotation) * 45,
                centerY + Math.sin(gameState.agent.rotation) * 45
            );
            ctx.stroke();
            
            // Campo de visión
            if (CONFIG.DEBUG_MODE) {
                ctx.strokeStyle = '#00D4AA20';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(centerX, centerY, 100, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function drawEffects(ctx) {
            // Partículas de datos
            if (Math.random() < 0.3) {
                ctx.fillStyle = `rgba(0, 212, 170, ${Math.random() * 0.5})`;
                ctx.fillRect(
                    Math.random() * gameCanvas.width,
                    Math.random() * gameCanvas.height,
                    2,
                    2
                );
            }
        }

        // ================= INTERFAZ =================
        function updateUI() {
            // Salud
            const healthPercent = (gameState.agent.health / gameState.agent.maxHealth) * 100;
            document.getElementById('healthFill').style.width = `${healthPercent}%`;
            document.getElementById('healthText').textContent = `${Math.round(healthPercent)}%`;
            
            // Energía
            const energyPercent = (gameState.agent.energy / gameState.agent.maxEnergy) * 100;
            document.getElementById('energyFill').style.width = `${energyPercent}%`;
            document.getElementById('energyText').textContent = `${Math.round(energyPercent)}%`;
            
            // Datos
            const dataPercent = (gameState.agent.dataCollected / gameState.agent.dataCapacity) * 100;
            document.getElementById('dataFill').style.width = `${dataPercent}%`;
            document.getElementById('dataText').textContent = 
                `${Math.round(gameState.agent.dataCollected / 100) / 10} GB`;
            
            // Nombre del agente
            document.getElementById('agentName').textContent = gameState.agent.name;
        }

        function updateMissionDisplay() {
            const mission = MISSIONS[gameState.mission.current - 1];
            
            document.getElementById('missionTitle').textContent = mission.title;
            document.getElementById('missionDesc').textContent = mission.description;
            document.getElementById('missionProgress').style.width = `${gameState.mission.progress}%`;
        }

        function updateMissionProgress() {
            updateMissionDisplay();
            
            if (gameState.mission.progress >= 100) {
                completeMission();
            }
        }

        function completeMission() {
            const mission = MISSIONS[gameState.mission.current - 1];
            
            showNotification(
                "MISIÓN COMPLETADA",
                `+${mission.reward.data} MB | +${mission.reward.exp} XP`
            );
            
            gameState.agent.dataCollected += mission.reward.data;
            gameState.agent.exp += mission.reward.exp;
            gameState.mission.completed.push(mission.id);
            
            // Subir de nivel
            const neededExp = gameState.agent.level * 1000;
            if (gameState.agent.exp >= neededExp) {
                gameState.agent.level++;
                gameState.agent.exp -= neededExp;
                showNotification("NIVEL SUBIDO", `¡Ahora eres nivel ${gameState.agent.level}!`);
            }
            
            // Siguiente misión
            if (mission.nextMission) {
                gameState.mission.current = mission.nextMission;
                gameState.mission.objectives = [...MISSIONS[mission.nextMission - 1].objectives];
                gameState.mission.progress = 0;
                
                // Nuevo diálogo
                setTimeout(() => {
                    const dialogueIndex = Math.min(mission.nextMission - 1, CHARACTERS.SALVOX.dialogues.length - 1);
                    showDialogue(CHARACTERS.SALVOX, CHARACTERS.SALVOX.dialogues[dialogueIndex]);
                }, 1000);
            }
            
            updateMissionDisplay();
            saveGame();
        }

        // ================= SISTEMA DE MENÚ =================
        function togglePause() {
            if (!gameLoaded || isHacking) return;
            
            if (isPaused) {
                resumeGame();
            } else {
                pauseGame();
            }
        }

        function pauseGame() {
            isPaused = true;
            pauseMenu.style.display = 'flex';
        }

        function resumeGame() {
            isPaused = false;
            pauseMenu.style.display = 'none';
            lastTime = performance.now();
        }

        function showSettings() {
            const settings = `
                AJUSTES DEL AGENTE:
                
                1. Sonido: ${gameState.settings.sound ? 'ACTIVADO' : 'DESACTIVADO'}
                2. Música: ${gameState.settings.music ? 'ACTIVADA' : 'DESACTIVADA'}
                3. Efectos: ${gameState.settings.effects ? 'ACTIVADOS' : 'DESACTIVADOS'}
                4. Auto-guardado: ${gameState.settings.autosave ? 'ACTIVADO' : 'DESACTIVADO'}
                
                Escribe el número para cambiar (o cancela):
            `;
            
            const choice = prompt(settings);
            switch(choice) {
                case '1':
                    gameState.settings.sound = !gameState.settings.sound;
                    break;
                case '2':
                    gameState.settings.music = !gameState.settings.music;
                    break;
                case '3':
                    gameState.settings.effects = !gameState.settings.effects;
                    break;
                case '4':
                    gameState.settings.autosave = !gameState.settings.autosave;
                    if (gameState.settings.autosave) {
                        autoSaveTimer = setInterval(saveGame, CONFIG.AUTO_SAVE_INTERVAL);
                    } else {
                        clearInterval(autoSaveTimer);
                    }
                    break;
            }
            
            if (choice && ['1', '2', '3', '4'].includes(choice)) {
                saveGame();
            }
        }

        function showCredits() {
            const credits = `
                COFONITA: AGENTE DE DATOS
                ========================
                
                HISTORIA ORIGINAL:
                En el año 2026, Cofonita es la IA que protege
                las comunidades de Discord. Los Fragmentadores,
                una organización rival, intentan corromper los datos.
                
                Tú eres un agente digital creado por Salvox
                para proteger la infraestructura de Cofonita.
                
                CRÉDITOS:
                • Idea original: Salvox Studios
                • Desarrollo: Easter Egg Team
                • Arte: Sistema de Cofonita V4
                • Música: Sintetizadores digitales
                
                Este es un easter egg especial del
                panel de control de Cofonita V4.
                
                ¿Encontraste todos los secretos?
            `;
            
            alert(credits);
        }

        function returnToMenu() {
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
                autoSaveTimer = null;
            }
            
            pauseMenu.style.display = 'none';
            uiOverlay.style.display = 'none';
            gameCanvas.style.display = 'none';
            mainMenu.style.display = 'flex';
            
            gameLoaded = false;
            saveGame();
        }

        // ================= INICIALIZACIÓN =================
        window.addEventListener('DOMContentLoaded', () => {
            loadGame();
        });

        window.addEventListener('beforeunload', () => {
            if (gameLoaded && gameState.settings.autosave) {
                saveGame();
            }
        });

        // Atajos de teclado
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                CONFIG.DEBUG_MODE = !CONFIG.DEBUG_MODE;
                console.log(`[Debug] Modo ${CONFIG.DEBUG_MODE ? 'activado' : 'desactivado'}`);
            }
        });
    </script>
</body>
</html>